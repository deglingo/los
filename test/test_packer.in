/* -*- c -*- */

header {
##include "los/lmemstream.h"
##include "los/lpacker.h"
##include "los/lunpacker.h"
##include "los/lint.h"
##include "los/lstring.h"
##include <string.h>
}

data {
  LStream *stream;
  LPacker *packer;
  LUnpacker *unpacker;
}

setup { 
  data->stream = l_mem_stream_new("", 0);
  data->packer = l_packer_new(data->stream);
  data->unpacker = l_unpacker_new(data->stream);
}

teardown {
  L_OBJECT_CLEAR(data->unpacker);
  L_OBJECT_CLEAR(data->packer);
  L_OBJECT_CLEAR(data->stream);
}

test
{
  PIF_CHECK(data->packer);
  PIF_CHECK(data->unpacker);
}

test
{
  GError *err = NULL;
  LObject *obj = L_OBJECT(l_int_new(92));
  gboolean r = l_packer_put(data->packer, obj, &err);
  PIF_CHECK(r);
  l_object_unref(obj);
  l_stream_seek(data->stream, 0, L_STREAM_SEEK_SET);
  obj = l_unpacker_get(data->unpacker, &err);
  PIF_CHECK(obj);
  PIF_CHECK(L_IS_INT(obj));
  PIF_CHECK(L_INT_VALUE(obj) == 92);
}

test
{
  GError *err = NULL;
  LObject *obj = L_OBJECT(l_string_new("test-string"));
  gboolean r = l_packer_put(data->packer, obj, &err);
  PIF_CHECK(r);
  l_object_unref(obj);
  l_stream_seek(data->stream, 0, L_STREAM_SEEK_SET);
  obj = l_unpacker_get(data->unpacker, &err);
  PIF_CHECK(obj);
  PIF_CHECK(L_IS_STRING(obj));
  PIF_CHECK(!strcmp(L_STRING(obj)->str, "test-string"));
}
