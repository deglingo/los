/* -*- c -*- */

header {
##include "los/lmemstream.h"
##include <string.h>
}

data
{ 
  LStream *stream;
}

setup
{
  data->stream = l_mem_stream_new("", 0);
}

teardown
{
  L_OBJECT_CLEAR(data->stream);
}

test
{ 
  PIF_CHECK(data->stream);
  l_stream_seek(data->stream, 0, L_STREAM_SEEK_SET);
}

#define CHECK_BUF(content) do {                                         \
    gsize cont_len = strlen(content);                                   \
    gsize len;                                                          \
    gpointer buf;                                                       \
    buf = l_mem_stream_get_buffer(L_MEM_STREAM(data->stream), &len);    \
    PIF_CHECK(cont_len == len);                                         \
    PIF_CHECK(len == 0 || buf);                                         \
    PIF_CHECK(!strncmp(buf, (content), len));                           \
  } while (0)

test /* empty buffer */
{
  CHECK_BUF("");
}

test /* write */
{
  GError *err = NULL;
  PIF_CHECK(l_stream_write(data->stream, "abcd", 4, &err));
  CHECK_BUF("abcd");
  PIF_CHECK(l_stream_write(data->stream, "efgh", 4, &err));
  CHECK_BUF("abcdefgh");
}

test /* write types */
{
  GError *err = NULL;
  PIF_CHECK(l_stream_write_u8(data->stream, 'A', &err));
  CHECK_BUF("A");
}
